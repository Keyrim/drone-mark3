/*
 * SPDX-FileCopyrightText: 2024 Th√©o Magne <theo.magne.fr@gmail.com>
 *
 * SPDX-License-Identifier: MIT
 */

/******************************************************************************
 * Includes
 ******************************************************************************/
#include "stm32f4xx_hal.h"

#include "bsp_uart.h"

#include "bsp.h"

/******************************************************************************
 * PRIVATE Configuration
 ******************************************************************************/

/******************************************************************************
 * PRIVATE Macro
 ******************************************************************************/

#define bspCPU_FREQ_MHZ (168U)

/******************************************************************************
 * PRIVATE type definitions
 ******************************************************************************/

/******************************************************************************
 * PRIVATE function prototypes
 ******************************************************************************/

/******************************************************************************
 * PRIVATE constant data definitions
 ******************************************************************************/

/******************************************************************************
 * PRIVATE variable definitions
 ******************************************************************************/

/******************************************************************************
 * PUBLIC implicit variable definitions (e.g. when no .h file)
 ******************************************************************************/

/******************************************************************************
 * PRIVATE Callback function
 ******************************************************************************/

/******************************************************************************
 * PRIVATE function
 ******************************************************************************/

/******************************************************************************
 * PUBLIC Callback function
 ******************************************************************************/

/******************************************************************************
 * PUBLIC function
 ******************************************************************************/

void bsp_init(void)
{
    UART_init();
}

void bsp_delay_ms(uint32_t ms)
{
    HAL_Delay(ms);
}

uint32_t bsp_get_time_us(void)
{
    uint32_t t_us;
    static uint32_t previous_t_us = 0;
    __disable_irq();
    t_us = HAL_GetTick() * 1000 + 1000 - SysTick->VAL / bspCPU_FREQ_MHZ;
    __enable_irq();

    if (previous_t_us > t_us)
    {
        t_us += 1000;
    }
    previous_t_us = t_us;

    return t_us;
}

void log_puts(const char *str, int len)
{
    UART_transmit(BSP_LOG_UART, (uint8_t *)str, len);
}
